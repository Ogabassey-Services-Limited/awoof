services:
  web:
    container_name: awoof-frontend-dev
    build:
      context: ../apps/web
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ../apps/web:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    env_file:
      - .env
    develop:
      watch:
        # Sync source files
        - action: sync
          path: ../apps/web/src
          target: /app/src
          ignore:
            - node_modules/

        # Sync app directory (for Next.js App Router)
        - action: sync
          path: ../apps/web/app
          target: /app/app
          ignore:
            - node_modules/

        # Sync pages directory (for Next.js Pages Router)
        - action: sync+restart
          path: ../apps/web/pages
          target: /app/pages
          ignore:
            - node_modules/

        # Sync components
        - action: sync
          path: ../apps/web/components
          target: /app/components
          ignore:
            - node_modules/

        # Sync styles
        - action: sync
          path: ../apps/web/styles
          target: /app/styles

        # Sync public assets
        - action: sync
          path: ../apps/web/public
          target: /app/public

        # Rebuild on package.json changes
        - action: rebuild
          path: ../apps/web/package.json

        # Sync config files with restart
        - action: sync+restart
          path: ../apps/web/next.config.js
          target: /app/next.config.js

        - action: sync+restart
          path: ../apps/web/next.config.mjs
          target: /app/next.config.mjs

        - action: sync+restart
          path: ../apps/web/tailwind.config.js
          target: /app/tailwind.config.js

        - action: sync+restart
          path: ../apps/web/tailwind.config.ts
          target: /app/tailwind.config.ts

  backend:
    build:
      context: ../apps/backend
      dockerfile: Dockerfile.dev
    container_name: awoof-backend-dev
    working_dir: /usr/src/app
    environment:
      - NODE_ENV=development
      - PORT=5000
      - DATABASE_URL=postgresql://root:root@db:5432/awoofDB
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=awoofDB
      - DB_USER=root
      - DB_PASSWORD=root
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ../apps/backend:/usr/src/app
      - /usr/src/app/node_modules
    ports:
      - "5001:5000"
    depends_on:
      - db
      - redis
    env_file:
      - ../apps/backend/.env
    develop:
      watch:
        # Watch for changes in source files
        - action: sync
          path: ../apps/backend/src
          target: /usr/src/app/src
          ignore:
            - node_modules/

        # Watch package.json for dependency changes
        - action: rebuild
          path: ../apps/backend/package.json

        # Sync other config files
        - action: sync
          path: ../apps/backend/tsconfig.json
          target: /usr/src/app/tsconfig.json

  db:
    container_name: awoof_postgres_container_dev
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: awoofDB
    ports:
      - "5432:5432"

  pgadmin:
    container_name: awoof_pgadmin_container_dev
    image: dpage/pgadmin4
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: root
    ports:
      - "5050:80"
    depends_on:
      - db

  redis:
    container_name: awoof_redis_container_dev
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

volumes:
  db_data:
  redis_data:
